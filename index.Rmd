---
title: "Beaches in Galicia"
author: "David Metacarpa, Caroline Tilton, and Luis de Pablo"
date: "December 8, 2021"
output:
 rmdformats::material:
   thumbnails: false
   highlight: "kate"
---

```{r setup, include = FALSE}
library(tidyverse)
library(rmdformats)
library(kableExtra) # for example code; delete if not needed

library(vegan)
library(usedist)

library(shiny)
library(leaflet)
library(shinythemes)

# Set code chunk defaults
knitr::opts_chunk$set(echo = FALSE,
                     message = FALSE,
                     warning = FALSE,
                     fig.align = "center")

# Set R environment options
options(knitr.kable.NA = '')
beaches <- read_csv("Data/beachData.csv")
controlSummary<- read.csv("Data/controlSummary.csv")
controlSummary <- controlSummary%>%
  select(-  X)

##correction for america 1 variable
controlSummary$site[1] <- "America 1"

```

# What Makes the Beaches in Galicia Unique?

## Playa America, Carnota, Corrubedo, Barra, Nerga, Lanzada, and Samil

### How do nutrients levels, algal cover, fauna diversity, pitch, and sediment levels vary between these beaches?


<!-- Add photo -->

```{r, fig.cap = "Playa de Soesto, Galicia, Spain"}
knitr::include_graphics("Data/beachimg.jpg")
```

Our blog is intended to inform users about the sediment nutrients, algal cover, fauna diversity, and locations of eight different sites in Galicia, Spain: Playa America, Carnota, Corrubedo, Barra, Nerga, Lanzada, and Samil. Our blog is centered around a shiny app that includes five different visualizations of beach characteristic variance. All of the visualizations have interactive widgets that allow users to compare different sites, treatments, and nutrient levels, as well as allowing users to click on and view the beaches where the data was collected.

We decided to focus on the individual characteristics of eight different beaches in Spain and how the beaches vary in biodiversity and geography. The data that we wrangled and analysed included species types, nutrients levels, locations, beach pitches, similarity, and experimental biodiversity levels.For each of the eight beaches, six samples of sediment, interstitial water, and surf water were analyzed for nutrient content of PO4, NO2 + NO3, and NH4. We looked at PO4 specifically because of the impact that it has on biodiversity in the area.

The data centered around biodiversity was taken during an experiment that compared biodiversity levels when bait was left in the sand. In the field, researchers collected sediment cores from about knee-deep in the water off the beach. These cores were taken back to the lab, where researchers identified all the species present and logged the number of representatives for each species. These data were used to estimate the density per square meter of each species, and it was used to identify the organism diversity found after three different treatments. The treatments included placing a piece of “bait” (squid) in the sand for 10 and 20 minutes, and after the duration of the treatment a 1m^2 core sample was taken from the sand.

```{r, fig.cap = "Playa Lanzada"}
knitr::include_graphics("Data/Screen Shot 2021-11-16 at 12.44.49 PM.png")
```

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For example, you can include **Bold** and _Italic_ and `Code` text.  For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

You should test out updating your GitHub Pages website:

* clone your group's blog project repo in RStudio
* update "Your Project Title Here" to a new title in the YAML header
* knit `index.Rmd` (we will now knit to HTML by default instead of pdf)
* commit and push **both** `index.Rmd` and `index.html`
* go to https://stat231-f21.github.io/blog_los-hermanos-intermareales/ to see the published test document (this is publicly available!)

## Including code and plots

You can embed code as normal, for example:

```{r cars}
summary(cars)
```

Let's clean up the format of that output instead of using the standard R output:

```{r pretty-table, echo = TRUE}
summary(cars) %>%
 kable(col.names = c("Speed", "Distance"),
       row.names = FALSE) %>%
 kable_styling(bootstrap_options = "striped",
               full_width = FALSE) %>%
 row_spec(0, bold = TRUE) %>%
 column_spec(1:2, width = "1.5in")
```

In a study from the 1920s, fifty cars were used to see how the speed of the car and the distance taken to stop were related.  Speeds ranged between `r min(cars$speed)` and `r max(cars$speed)` mph.  Distances taken to stop ranged between `r min(cars$dist)` and `r max(cars$dist)` feet, with the middle 50% falling between `r as.numeric(quantile(cars$dist)[2])` and `r as.numeric(quantile(cars$dist)[4])` feet. 

You can also embed plots as normal, for example:

```{r figure1}
ggplot(data = cars, aes(x = speed, y = dist)) +
 geom_point() +
 labs(x = "Speed of car (mph)",
      y = "Distance taken to stop (ft)",
      title = "Stopping distance increases with faster speeds",
      subtitle = "Based on 1920s study") +
 theme_classic()
```

Take note of the default code chunk options in the `setup` code chunk, and adjust individual code chunk options as needed. for example, unlike the rest of the Rmd files we worked in this semester, the default code chunk option is `echo = FALSE`, so you will need to set `echo  = TRUE` for any code chunks you would like to display in the blog.


## Including links and images/videos

You can include [links](https://www.datadreaming.org/post/r-markdown-theme-gallery/) and there are a few ways to embed  images! Both options for embedding images below can be used interchangeably. They both work for png, pdf, jpg, and even gif formats, and both support filepaths that are either URLs (for videos, you can include links to any valid YouTube or Vimeo URLs; see [here](https://bookdown.org/yihui/rmarkdown/learnr-videos.html) for more details) or point to a location within your project directory.

### Option 1: Markdown approach

![This is a figure caption. The artwork is called Safe Space by  [Kenesha Sneed](https://www.keneshasneed.com/#/safespace/)](img/Kenesha-Sneed_safe-space.jpeg)


### Option 2: Code chunk approach

```{r, fig.cap = "This is also figure caption"}
knitr::include_graphics("https://media.giphy.com/media/H7ZrrA9V2pd3Tehdds/giphy.gif")
```

## Including equations

Equations may be needed if you are explaining a new technique or perhaps providing some other relevant formulas in your exposition. There are two ways to include equations:

* Inline: $b \sim N(0, \sigma^2_b)$
* Display-style (displayed on its own line): $$\frac{\sigma^2_b}{\sigma^2_b + \sigma^2_e}$$

For typesetting equations appropriately, take a look at the *Symbols in math mode* section of this  [cheat sheet](https://users.dickinson.edu/~richesod/latex/latexcheatsheet.pdf)  (or do some extra Googling---there are *many* resources).


<!-- add new tabs -->
# Beach Views {.tabset .tabset-fade .tabset-pills}

```{r, fig.cap = "This is also figure caption", echo = TRUE}
shinyApp(
  ui <- fluidPage(

    # Application title
    titlePanel(
      h1("Beach Locations",h3("Click on beach markers to view photo-spheres"))
    ),
    theme = shinytheme("superhero"),
    
    mainPanel(
      leafletOutput("beachMap")
    )
  ),
  
  # Define server logic required to draw a histogram
  server <- function(input, output) {
  
      output$beachMap <- renderLeaflet({
          leaflet(data = beaches) %>%
              addTiles() %>%
              addMarkers(popup = beaches$link)
      })
  },
  
  options = list(height = 600)
)

```


# Cluster Analysis {.tabset .tabset-fade .tabset-pills}

```{r, fig.cap = "Hierarchical Clustering of Beaches by Fauna Composition", echo = TRUE}

#bray-curtis dissimilarity index comparison/groupings
bray_dist <- vegdist(controlSummary[-1], method = "bray")

names <- controlSummary[[1]]
bray_dist <- dist_setNames(bray_dist, names)

plot(
  hclust(bray_dist),
  hang = -1,
  main = "Sites clustered by Bray-Curtis similarity",
  axes = FALSE, ylab = "", xlab = "",
  sub = "")

```

```{r, fig.cap = "Non-metric Multidimensional Scaling of Beaches by Fauna Composition (Stress = 0.072)", echo = TRUE, message = FALSE, results = 'hide'}
#NMDS (also using bray-curtis dissimilarity)
nmds <- metaMDS(controlSummary[-1], distance = "bray")

pointData <- data.frame(nmds$points) %>%
  mutate(site = controlSummary$site)

speciesData <- data.frame(nmds$species)

#plot sites
ggplot() +
  geom_point(data = pointData, size = 8, alpha = 0.5, aes(x = MDS1, y = MDS2, col = site))

```

  The cluster analysis depicts how similar all of the beaches are based on the Bray-curtis similarity index. We use the control data for species density in order. Bray-Curtis similarity gauges the similarity of diversity sample sets and takes the ratio of the two times the intersection over the sum, with an index range from zero to one.  In other words, if two beaches are exactly the same, the intersection and union of data would be the same so the Bray-Curtis similarity between the two would be equal to 1.
  
  There are several commonly-used similarity indeces, including Jaccard, Sorensen, and Bray-Curtis. Jaccard and Sorensen are based solely on species incidence but Bray-Curtis is calculated using species abundance. Jaccard only focuses on whether species are present are not but Bray-Curtis accounts for the species abundance. We chose to use Bray-Curtis when comparing beaches since we have data on species abundance, and since species abundance is ecologically relevant.
  
  The first visualization depicts a hierarchical clustering of similarity. Here, more similar sites are grouped more closely together. This model was constructed from a dissimilarity matrix containing comparisons of all the sites. The second visualization is a non-metric multidimensional scaling plot constructed from the same data. In this plot, the distance between points is their dissimilarity. Points that are close together are more likely to be similar than points ordinated far apart from each other.


# Fauna Diversity {.tabset .tabset-fade .tabset-pills}
```{r, fig.cap = "Average Diversity between Treatments", echo = TRUE}
  #comparison of treatments
diversityData <- beaches %>%
  select(c("site", "controlDiversity", "tenMinDiversity", "twentyMinDiversity")) %>%
  pivot_longer(-site, names_to = "treatment", values_to = "diversity")

diversityData$treatment <- str_replace_all(diversityData$treatment, pattern = "tenMinDiversity", replacement = "10")
diversityData$treatment <- str_replace_all(diversityData$treatment, pattern = "twentyMinDiversity", replacement = "20")
diversityData$treatment <- str_replace_all(diversityData$treatment, pattern = "controlDiversity", replacement = "control")

#average diversity between treatments
ggplot(data = diversityData, aes(x = treatment, y = diversity)) +
  geom_boxplot()
```
We can add text here to describe the plots of diversity based on treatment
The link to the app is included here
```{r, fig.cap = "Shiny App for Interactive facets of Diversity between Treatments"}
#knitr::include_app("https://your-account.shinyapps.io/your-app/", height = "600px")
```

  In the field, researchers collected sediment cores from about knee-deep in the water off beaches in order to gather data to measure fauna diversity. These cores were taken back to the lab, where researchers identified all the species present and logged the number of representatives for each species. These data were used to estimate the density per square meter of each species. Bar chart compares the organism diversity found after three different treatments. The treatments included placing a piece of “bait” (squid) in the sand for 10 and 20 minutes, and after the duration of the treatment a 1m^2 core sample was taken from the sand. We included a widget for the bar graph that allows users to select the site location where each experiment was performed, and this allows users to easily compare the effectiveness of the treatments and the diversity levels from the array of sites. There was no significant pattern found from the results of all the different sites, but interactions between different organisms did affect the results of the treatments. There was no obvious trend across all of the beaches, but at sites, like Barra, where there was less diversity found after the treatment, we considered the idea that the bait could have drawn one or two specific organisms that either scared away or beat out other organisms. And at sites like Lanzada, where there was more diversity found with the ten and twenty minute treatments, we thought that the bait could have drawn a wider variety of species, leading to more diversity.

```{r, fig.cap = "All beach facets included in shiny app"}
#ASK SDS ABOUT HOW TO INCORPERATE APPS INTO THE BLOG
ggplot(data = diversityData, aes(x = treatment, y = diversity)) +
  geom_col(aes(fill = treatment)) +
  scale_color_brewer() +
  theme_bw() +
  facet_wrap(~ site)

```
# Algae Cover {.tabset .tabset-fade .tabset-pills}
```{r, fig.cap = "Algae Cover"}

#algae cover vs nutrients
ggplot(data = beaches, aes(x = po4SedMean, y = algaePercentCover)) +
  geom_point() +
  geom_smooth(method = 'lm') +
  ylim(0, 4)

```

In order to gauge algal cover, algal wracks were measured at six transects along each beach, and they were measured from the high water mark to the base of the dunes at the top of the beach. We used these data to estimate the percent cover of algae on each beach. Here, we visualize the relationship between fauna diversity and algal cover. The interactive portion of this tab allows us to switch between two different measures of diversity, the Shannon Diversity Index, which takes into account the number and abundance of species, and the species richness, which measures only the number of species encountered. Note the positive relationship between diversity and algal cover. Algal wrack provides a food source for many animals on the beach, so a higher cover of algae could allow for greater diversity

# Nutrient Levels {.tabset .tabset-fade .tabset-pills}
```{r, fig.cap = "Nutrient Levels Across Beaches"}
#assemble plots of nutrient data
library(cowplot)

sedpo4 <- ggplot(data = beaches, aes(x = po4SedMean, y = controlDiversity)) +
  geom_point() +
  geom_smooth(method = 'lm') +
  ylim(0, 2.5) +
  labs(x = "PO4 Density (ug/g)", y = "Shannon Diversity Index")

sedno2no3 <- ggplot(data = beaches, aes(x = no2no3SedMean, y = controlDiversity)) +
  geom_point() +
  geom_smooth(method = 'lm') +
  ylim(0, 2.5) +
  labs(x = "NO2NO3 Density (ug/g)", y = "")

sednh4 <- ggplot(data = beaches, aes(x = nh4SedMean, y = controlDiversity)) +
  geom_point() +
  geom_smooth(method = 'lm') +
  ylim(0, 2.5) +
  labs(x = "NH4 Density (ug/g)", y = "")

plot_grid(sedpo4, sedno2no3, sednh4, labels = "auto", align = "h", ncol = 3)
```

For each of the eight beaches, six samples of sediment, interstitial water, and surf water were analyzed for the nutrient content of PO4, NO2 + NO3, and NH4.  Above are two lines of best fit for the biodiversity of the beaches versus the PO4 and NO2 + NO3 content in the sediment, in micrograms nutrient per gram sediment.  While there tends to be a lot more PO4 in the sediment than NO2 + NO3, since the line of best fit’s slope is closer to zero, biodiversity is more impacted by NO2 + NO3 content than it is by PO4 content.  Another key difference between the two is that as PO4 content increases, biodiversity tends to slightly decline (<0.1 points less per microgram nutrient added), while as NO2 + NO3 content increases, biodiversity also tends to increase (~10 points more per microgram nutrient added).

Also, as you can see by the size of the shaded region of uncertainty, the variation between data points on the graph for PO4 is much larger than that of NO2 + NO3.  This means that biodiversity has a stronger linear correlation with NO2 + NO3 content than it does with PO4 content.  While it is impossible to tell by these data whether these nutrients cause differences in biodiversity, it is important to acknowledge their relationships of varying significance are certainly present.

# Sediment Levels {.tabset .tabset-fade .tabset-pills}


Every subsection heading (starting with `##`) until you create a new section heading (starting with `#`) will be a new tab.

## Bulleted list

You can make a bulleted list like this:

* item 1
* item 2
* item 3


## Numbered list

You can make a numbered list like this

1. First thing I want to say
2. Second thing I want to say
3. Third thing I want to say

# Customizing your blog design

As a *final* detail **only** if you have time, you can explore options for customizing the style of your blog. By default, we are using the `readthedown` theme from the [**rmdformats** package](https://github.com/juba/rmdformats) (see Line 6 of this file if you want to switch out themes). There are, I'm sure, many many many more similar packages with built in themes, or you can look into how to include a CSS code chunk to customize aspects of the current theme. 

There are some easy-to-change options that you can play around with:

* The theme itself (Line 6): `rmdformats::readthedown`, `rmdformats::downcute`, `rmdformats::robobook`, `rmdformats::material`,
 * For `downcute` only, you can add a new indented line below Line 6 with the code `downcute_theme: "chaos"` for the `downcute chaos` theme
 * I would *not* recommend the other themes that do not have the sidebar navigation

* Syntax highlighting options (Line 8, `highlight`): `"default"`, `"tango"`, `"pygments"`, `"kate"`, `"monochrome"`, `"espresso"`, `"zenburn"`, `"haddock"`, or `"textmate"` (or `NULL` for no syntax highlighting)


You can explore additional customizable YAML options by looking at the [**rmdformats** package](https://github.com/juba/rmdformats) page or running, for example, `?rmdformats::readthedown()` to see the help documentation for a particular theme from the package.